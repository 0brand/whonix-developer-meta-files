#!/bin/bash

## This file is part of Whonix.
## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

set -x
true "INFO: Currently running script: $0${1+"$@"}"
set -o pipefail

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

## disable cmd line parser, since not needed
export WHONIX_BUILD_PARSED="1"
export VMNAME="internalrun"
ROOT_CHECK="0"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$MYDIR"

source ../../Whonix/help-steps/pre
source ../../Whonix/help-steps/variables

#project="testprojectwh"
#project="whonix"
project="whonixdevelopermetafiles"

version="$whonix_build_closest_git_tag"

ls -la "$WHONIX_BINARY/sha512sum"
ls -la "$WHONIX_BINARY/"*".ova"
ls -la "$WHONIX_BINARY/"*".qcow2.tar.gz"
ls -la "$WHONIX_BINARY/"*".asc"

true "${cyan}INFO: Press any enter to continue.${reset}"
read temp

## Test.
rsync \
   --dry-run \
   --partial \
   --progress \
   --verbose \
   "$WHONIX_BINARY/sha512sum" \
   "$WHONIX_BINARY/"*".ova" \
   "$WHONIX_BINARY/"*".qcow2.tar.gz" \
   "$WHONIX_BINARY/"*".asc" \
   "adrelanos,$project@frs.sourceforge.net:/home/frs/project/$project/$version/"

true "${cyan}INFO: Press any enter to continue.${reset}"
read temp

attempts_counter="0"
attempts_max="10"

while true; do
   attempts_counter="$(( $attempts_counter + 1 ))"

   rsync_exit_code="0"
   rsync \
      --partial \
      --progress \
      --verbose \
      "$WHONIX_BINARY/sha512sum" \
      "$WHONIX_BINARY/"*".ova" \
      "$WHONIX_BINARY/"*".qcow2.tar.gz" \
      "$WHONIX_BINARY/"*".asc" \
      "adrelanos,$project@frs.sourceforge.net:/home/frs/project/$project/$version/" \
      || { rsync_exit_code="$?" ; true; };

   if [ "$rsync_exit_code" = "0" ]; then
      break
   fi

   if [ "$attempts_counter" -ge "10" ]; then
      msg="${bold}${red}INFO: Upload failed.${reset}"
      true "$msg"
      error "$msg"
   fi

   sleep 10

done

benchmark_time_end ## sets benchmark_took_time (implemented in help-steps/pre)
true "${bold}INFO: End of: $0 No error detected. (benchmark: $benchmark_took_time)${reset}"
